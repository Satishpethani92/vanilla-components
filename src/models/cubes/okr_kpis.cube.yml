cubes:
  - name: okr_kpis
    title: OKR KPIs
    sql_alias: okr_kpi
    data_source: my-db
    sql: >
      SELECT *
      FROM csdb.kr_kpi

    dimensions:
      - name: krk_id
        sql: krk_id
        type: number
        primary_key: true
        title: 'OKR KPI ID'

      - name: krs_id
        sql: krs_id
        type: number
        title: 'OKR (Objective) ID'

      - name: kpi_id
        sql: kpi_id
        type: number
        title: 'KPI Template ID'

      - name: kpi_name
        sql: kpi_name
        type: string
        title: 'KPI Name'

      - name: start_date
        sql: start_date
        type: time
        title: 'Start Date'

      - name: end_date
        sql: end_date
        type: time
        title: 'End Date'

      - name: assigned_to
        sql: assigned_to
        type: number
        title: 'Assigned User ID'

      - name: status
        sql: status
        type: number
        title: 'Status ID'

      - name: active_status
        sql: active_status
        type: number
        title: 'Active Status'

      - name: target
        sql: target
        type: string
        title: 'Target'

      - name: kpi_type
        sql: kpi_type
        type: string
        title: 'KPI Type'

      - name: measure_period
        sql: measure_period
        type: string
        title: 'Measure Period'

      - name: day_measure
        sql: day_measure
        type: string
        title: 'Day Measure'

      - name: measure
        sql: measure
        type: string
        title: 'Measure'

      - name: expected_score
        sql: expected_score
        type: number
        title: 'Expected Score'

      - name: actual_score
        sql: actual_score
        type: number
        title: 'Actual Score'

      - name: comments
        sql: comments
        type: string
        title: 'Comments'

      - name: create_user
        sql: create_user
        type: number
        title: 'Created By (User ID)'

      - name: create_time
        sql: create_time
        type: time
        title: 'Create Time'

      - name: update_user
        sql: update_user
        type: number
        title: 'Updated By (User ID)'

      - name: update_time
        sql: update_time
        type: time
        title: 'Update Time'

      - name: obj_id
        sql: obj_id
        type: string
        title: 'Object ID'

      - name: created_by_goal
        sql: created_by_goal
        type: boolean
        title: 'Created By Goal?'

      - name: is_start
        sql: is_start
        type: boolean
        title: 'Is Start?'

      - name: is_archive
        sql: is_archive
        type: boolean
        title: 'Is Archive?'

      - name: lower_limit
        sql: lower_limit
        type: string
        title: 'Lower Limit'

      - name: upper_limit
        sql: upper_limit
        type: string
        title: 'Upper Limit'

      # ---------------------------------------------------
      # Inline subqueries for fields from other tables
      # ---------------------------------------------------

      - name: assigned_user_photo_url
        sql: ( SELECT user_photo_url FROM csdb.user WHERE usr_id = {CUBE}.assigned_to )
        type: string
        title: 'Assigned User Photo'

      - name: assigned_user_name
        sql: ( SELECT IFNULL(CONCAT(first_name, ' ', last_name), user_name) FROM user WHERE usr_id = {CUBE}.assigned_to )
        type: string
        title: 'Assigned User Name'

      - name: kpi_type_target
        sql: ( SELECT kpi_type_target FROM kpi_org_template WHERE kot_id = {CUBE}.kpi_id )
        type: string
        title: 'KPI Type Target'

      - name: perspective_name
        sql: ( SELECT p.name FROM kpi_org_template kot JOIN perspectives p ON p.per_id = kot.perspective_id WHERE kot.kot_id = {CUBE}.kpi_id )
        type: string
        title: 'Perspective Name'

      - name: per_id
        sql: ( SELECT p.per_id FROM kpi_org_template kot JOIN perspectives p ON p.per_id = kot.perspective_id WHERE kot.kot_id = {CUBE}.kpi_id )
        type: number
        title: 'Perspective ID'

      - name: status_name
        sql: ( SELECT s.name FROM master_table s WHERE s.msr_id = {CUBE}.status )
        type: string
        title: 'Status Name'

      - name: status_font_color
        sql: ( SELECT s.font_color FROM master_table s WHERE s.msr_id = {CUBE}.status )
        type: string
        title: 'Status Font Color'

      - name: status_background_color
        sql: ( SELECT s.background_color FROM master_table s WHERE s.msr_id = {CUBE}.status )
        type: string
        title: 'Status Background Color'

    joins:
      - name: okr
        sql: '{CUBE}.obj_id = {okr}.obj_id'
        relationship: many_to_one

      - name: okr_kpi_records
        sql: '{CUBE}.krk_id = {okr_kpi_records}.krk_id'
        relationship: one_to_many
